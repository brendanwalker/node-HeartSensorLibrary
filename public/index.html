<!DOCTYPE html>
<html>

<head>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script type="text/javascript">
    const ppgMaxSamples = 100;
    var ppgTime = 0.0;
    var ppgDataSet = {
      x: [],
      y: [],
      type: 'lines+markers',
      name: 'ppg_data'
    };
    var ppgGraphLayout = {
      title: 'Photoplethysmogram',
      xaxis: {
        title: 'Time',
        showgrid: false,
        zeroline: false
      },
      yaxis: {
        title: 'PPG',
        showline: false
      }
    };

    const gsrMaxSamples = 100;
    var gsrDataSet = {
      x: [],
      y: [],
      mode: 'lines+markers',
      name: 'gsr_data'
    };
    var gsrGraphLayout = {
      title: 'Galvanic Skin Response',
      xaxis: {
        title: 'Time',
        showgrid: false,
        zeroline: false
      },
      yaxis: {
        title: 'milli-volts',
        showline: false
      }
    };

    function handleJSONString(jsonString) {
      const jsonData = JSON.parse(jsonString);
      const sensorID = jsonData['id'];
      const sensorType = jsonData['type'];
      const sensorStreamData = jsonData['stream']

      if (sensorType == 'ppg') {

        sensorStreamData.forEach(function (streamData) {
          const ppgSamples = streamData['ppgSamples'];
          const ppgSampleDelta = streamData['timeDeltaInSeconds'];

          ppgSamples.forEach(function (ppgSample) {
            const ppgValue0 = ppgSample['ppgValue0'];

            ppgDataSet['y'].push(ppgValue0);
            ppgDataSet['x'].push(ppgTime)
            if (ppgDataSet['x'].length > ppgMaxSamples) {
              ppgDataSet['x'].shift();
              ppgDataSet['y'].shift();
            }

            ppgTime += ppgSampleDelta;
          });
        });

        Plotly.update('ppgGraph', [ppgDataSet], ppgGraphLayout);
      }
      else if (sensorType == 'gsr') {
        sensorStreamData.forEach(function (streamData) {
          const gsrSample = streamData['gsrValue'];
          const gsrTime = streamData['timeInSeconds'];

          console.log(gsrSample.toString());

          gsrDataSet['y'].push(gsrSample);
          gsrDataSet['x'].push(gsrTime)
          if (gsrDataSet['x'].length > gsrMaxSamples) {
            gsrDataSet['x'].shift();
            gsrDataSet['y'].shift();
          }
        });

        Plotly.update('gsrGraph', [gsrDataSet], gsrGraphLayout);
      }
    }

    document.addEventListener('DOMContentLoaded', function () {
      Plotly.newPlot('ppgGraph', [ppgDataSet], ppgGraphLayout);
      Plotly.newPlot('gsrGraph', [gsrDataSet], gsrGraphLayout);

      // Run this once after the DOM is loaded
      if (!!window.EventSource) {
        var source = new EventSource('data');
        source.addEventListener('message', function (e) {
          handleJSONString(e.data)
        }, false);
      }
      else {
        console.log('Server-Stream-Event not supported');
      }
    }, false);
  </script>
</head>

<body>
  <div id="ppgGraph" style="width:600px;height:250px;"></div>
  <div id="gsrGraph" style="width:600px;height:250px;"></div>
</body>

</html>